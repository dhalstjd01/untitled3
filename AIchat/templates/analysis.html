<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8f9fa;
        }
        .chart-container {
            position: relative;
            margin: auto;
            height: 60vh;
            max-height: 450px;
            width: 90vw;
            max-width: 450px;
        }
        /* 진단 패널 스타일 */
        .debug-panel {
            background-color: #212529;
            color: #f8f9fa;
            padding: 20px;
            margin-top: 40px;
            border-radius: 8px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
    <title>감정 분석 결과</title>
</head>
<body>
<div class="container my-5">
    <div class="text-center">
        <h1 class="mb-3">나의 감정 분석</h1>
        <p class="lead text-muted">{{ most_common_emotion_text | safe }}</p>
    </div>

    <div class="chart-container mt-4">
        <canvas id="emotionChart"></canvas>
    </div>

    <div class="text-center mt-4">
        <!-- [수정] bot_type을 동적으로 받아 올바른 채팅방으로 돌아갑니다. -->
        <a href="{{ url_for('chat', bot_type=bot_type) }}" class="btn btn-primary">채팅으로 돌아가기</a>
    </div>



<!-- Chart.js 라이브러리 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
      // Flask에서 전달된 JSON 데이터를 JavaScript 객체로 변환합니다.
      // 템플릿에서 이미 JSON 문자열이므로, 바로 파싱합니다.
      const chartData = JSON.parse(`{{ chart_data | safe }}`);
      const chartContainer = document.querySelector('.chart-container');
      const ctx = document.getElementById('emotionChart').getContext('2d');

      // 차트에 표시할 데이터가 있는지 확인합니다.
      if (!chartData.labels || chartData.labels.length === 0) {
        chartContainer.innerHTML = '<div class="alert alert-info text-center">아직 분석된 감정이 없습니다. 챗봇과 대화를 나눠보세요!</div>';
      } else {
        new Chart(ctx, {
          type: 'pie',
          data: chartData,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: { font: { size: 14 }, padding: 20 }
              },
              tooltip: {
                callbacks: {
                    label: function(context) {
                        let label = context.label || '';
                        if (label) label += ': ';
                        if (context.parsed !== null) label += context.parsed + '회';
                        return label;
                    }
                }
              }
            }
          }
        });
      }
    });
</script>

</body>
</html>